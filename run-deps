#!/usr/bin/env bash
set -euo pipefail

BASE_LOGDIR="$HOME/dev/logs/deps/run-deps"
TS="$(date +%Y%m%d-%H%M%S)"
LOGDIR="$BASE_LOGDIR/$TS"
mkdir -p "$LOGDIR"
LOGFILE="$LOGDIR/run-deps-$TS.log"

(
echo "=== run-deps started: $(date) ==="
echo "Writing log to $LOGFILE"
echo ""

ensure_container_system() {
  if container system status >/dev/null 2>&1; then
    return
  fi
  echo "container system not running â€” starting (sudo)..."
  sudo container system start
  echo "container system started."
}

start_container() {
  local name="$1"
  local image="$2"
  shift 2
  local args=("$@")

  if container inspect "$name" >/dev/null 2>&1; then
    echo "Removing existing container '$name'..."
    container rm -f "$name" >/dev/null 2>&1 || true
  fi

  echo "Starting $name using image $image ..."
  container run -d --name "$name" "${args[@]}" "$image"
}

print_ports() {
  local name="$1"
  echo "Ports:"
  container inspect "$name" 2>/dev/null | grep -A5 "Ports" || echo "  n/a"
  echo ""
}

main() {
  ensure_container_system

  # Start services
  start_container dev-redis redis:latest -p 6379:6379
  start_container dev-rabbitmq rabbitmq:4-management -p 5672:5672 -p 15672:15672

  echo ""
  echo "ðŸ“¦ Running containers:"
  container list
  echo ""

  echo "ðŸ” Redis info (dev-redis):"
  print_ports dev-redis

  echo "ðŸ” RabbitMQ info (dev-rabbitmq):"
  print_ports dev-rabbitmq

  echo "âœ¨ Access:"
  echo "  Redis: redis://localhost:6379"
  echo "  RabbitMQ (AMQP): amqp://localhost:5672"
  echo "  RabbitMQ UI: http://localhost:15672"
  echo ""

  echo "ðŸŽ‰ All dependencies started successfully!"
}

main

) 2>&1 | tee "$LOGFILE"
